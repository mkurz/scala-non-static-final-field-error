# UPDATE: This will be fixed in upcoming Scala 2.13.2

Pull request: https://github.com/scala/scala/pull/8514

Checkout the [`scala-fix` branch](https://github.com/mkurz/scala-non-static-final-field-error/tree/scala-fix), which [uses the (currently) latest Scala 2.13.x nightly](https://github.com/mkurz/scala-non-static-final-field-error/blob/scala-fix/build.sbt#L5-L6). It works!

# Prerequisites

- JDK 11 (I'm using AdoptOpenJDK):

```sh
$ java -version
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment AdoptOpenJDK (build 11.0.6+10)
OpenJDK 64-Bit Server VM AdoptOpenJDK (build 11.0.6+10, mixed mode)
```

(You will not see the error with JDK 8!)

- Scala 2.13.1

- My system is running `Ubuntu 18.04`.

- **Important:** `scalac` needs to use the `-target:11` flag (see [`build.sbt`](https://github.com/mkurz/scala-non-static-final-field-error/blob/master/build.sbt#L9)), otherwise you won't see the error.

# How to reproduce

1. Clone this repo

1. Run the project: `sbt clean run`

1. Send a request from another terminal: `curl http://127.0.0.1:9000`

Voil√†! You will now see the exception:

```
Caused by: java.lang.IllegalAccessError: Update to non-static final field hello.Routes.defaultPrefix attempted from a different method (controllers_HomeController_foo0_route$lzycompute) than the initializer method <init> 
	at hello.Routes.controllers_HomeController_foo0_route$lzycompute(Routes.scala:47)
	at hello.Routes.hello$Routes$$controllers_HomeController_foo0_route(Routes.scala:47)
	at hello.Routes$$anonfun$routes$1.applyOrElse(Routes.scala:68)
	at hello.Routes$$anonfun$routes$1.applyOrElse(Routes.scala:65)
	at scala.PartialFunction$Lifted.apply(PartialFunction.scala:310)
	at scala.PartialFunction$Lifted.apply(PartialFunction.scala:306)
	at play.core.routing.Include.unapply(GeneratedRouter.scala:49)
	at router.Routes$$anonfun$routes$1.applyOrElse(Routes.scala:53)
	at router.Routes$$anonfun$routes$1.applyOrElse(Routes.scala:50)
	at scala.PartialFunction$Lifted.apply(PartialFunction.scala:310)

```

# Apply the workaround

1. Checkout the `workaround` branch: `git checkout workaround`

1. Again run the project: `sbt clean run`

1. Again send a request from another terminal: `curl http://127.0.0.1:9000`

It works!

# What's going on

The Problem is caused by the `Routes.scala` file, which gets generated by the Play Framework when you compile (or run) the project (see `target/scala-2.13/routes/main/hello/Routes.scala`).
It seems the bytecode `scalac` produces for this file (for this specific project) is not correct (or at least not compatible with Java 11).
That's why I decompiled the `Routes.class` file (and its companion `Routes$$anonfun$routes$1.class`) which `scalac` generates and had a closer look (I added those mentioned files to the [`generated-files`](https://github.com/mkurz/scala-non-static-final-field-error/tree/generated-files/target/scala-2.13/routes/main/hello) branch):
If you look at the decompiled `Routes.class` file ([`Decompiled-Routes.java`](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Decompiled-Routes.java)), you will see [the line](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Decompiled-Routes.java#L81) that causes the exception:

```java
this.defaultPrefix = null;
```

This line seems incorrect. Why does the method [`controllers_HomeController_foo0_route$lzycompute()`](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Decompiled-Routes.java#L69) even set [the final variable `defaultPrefix`](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Decompiled-Routes.java#L38) to `null`? This variable was [initialized in the constructor](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Decompiled-Routes.java#L161) already, so it should be not allowed to change it afterwards, which actually is what Java 11 is complaining about.
As you can see in the exception above, the line which causes this faulty bytecode to be generated seems to be [`Routes.scala:47`](https://github.com/mkurz/scala-non-static-final-field-error/blob/generated-files/target/scala-2.13/routes/main/hello/Routes.scala#L47).

Now, if you look what happens when you apply to workaround (which just [adds a second route and action method](https://github.com/mkurz/scala-non-static-final-field-error/compare/master...workaround), nothing more), you will see the `this.defaultPrefix = null;` is now gone in the decompiled class file:
https://github.com/mkurz/scala-non-static-final-field-error/compare/generated-files...generated-files-with-workaround#diff-bc53f6c835819da584738ac55158d5aeL81

Here you can also see the diff of the generated `Routes.scala` file:
https://github.com/mkurz/scala-non-static-final-field-error/compare/generated-files...generated-files-with-workaround#diff-6ec7a2102d5e6f5d0e58ea4c34b7f882
It just adds the second route, nothing more.

I think this behaviour is a bit weird.
